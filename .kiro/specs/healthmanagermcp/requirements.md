# Requirements Document - HealthManagerMCP

## Introduction

HealthManagerMCPは、Healthmateエコシステムの一部として、ユーザーの健康情報を記録・管理するMCPサーバーです。AWS Bedrock AgentCore Gatewayを使用してMCP（Model Context Protocol）エンドポイントを提供し、HealthCoachAIやその他のAIクライアントが健康データの記録と取得を行えるようにします。本システムはバックエンドAPIサーバーとしてのみ機能し、UI/AIエージェントは提供しません。

## Healthmateエコシステム

Healthmateは以下の3つのプロジェクトで構成されます：

- **HealthManagerMCP**（このプロジェクト）: MCPサーバーでユーザーの健康情報の管理を行う
- **HealthCoachAI**（別プロジェクト）: HealthManagerMCPをツールとして利用するユーザーの健康上のアドバイスをして導くエージェントAI
- **HealthmateUI**（別プロジェクト）: このアプリのフロントUI

## Glossary

- **System**: HealthManagerMCP健康情報記録MCPサーバー
- **User**: システムを利用する個人ユーザー
- **HealthCoachAI**: HealthManagerMCPをツールとして利用する健康アドバイスエージェントAI
- **HealthmateUI**: Healthmateアプリのフロントエンドユーザーインターフェース
- **AI Client**: 外部のAIシステム（HealthCoachAI、ChatGPT、Claude、Geminiなど）
- **AgentCore Gateway**: AWS Bedrock AgentCoreが提供するMCPゲートウェイサービス
- **MCP**: Model Context Protocol - AIシステム間の通信プロトコル
- **Health Goal**: ユーザーの健康に関する長期的な目標（100歳まで健康寿命、アスリート体型など）
- **Health Policy**: ユーザーの健康に関する具体的な行動ルール（ローカーボダイエット、16時間ファスティング、お酒は禁止など）
- **Activity**: ユーザーの日々の健康活動記録（体重、食事、運動、気分など）
- **Cognito**: AWS Cognitoが提供するユーザー認証サービス
- **OAuth 2.0**: 認証・認可のための標準プロトコル

## Requirements

### Requirement 1: ユーザー認証とアクセス制御

**ユーザーストーリー:** AIクライアントとして、ユーザーの健康データに安全にアクセスしたい。そうすることで、認証されたユーザーの健康データのみを取得・更新できるようになる。

#### 受入基準

1. WHEN AIクライアントがMCP経由でシステムにアクセスする THEN システムはCognitoを使用してOAuth 2.0 Authorization Code Grantでユーザーを認証しなければならない
2. WHEN 認証が成功する THEN システムは1時間有効なアクセストークンと30日間有効なリフレッシュトークンを発行しなければならない
3. WHEN MCPリクエストが送信される THEN システムはJWTトークンを検証し、トークンクレームからuserIdを抽出しなければならない
4. WHEN トークン検証が失敗する THEN システムは認証エラーでMCPリクエストを拒否しなければならない

### Requirement 2: ユーザー情報管理

**ユーザーストーリー:** ユーザーとして、プロフィール情報と健康目標を管理したい。そうすることで、システムが目標に向けた進捗を追跡できるようになる。

#### 受入基準

1. WHEN 新しいユーザーが登録する THEN システムはuserId、username、email、goalsを含むユーザーレコードを作成しなければならない
2. WHEN ユーザーがプロフィールを更新する THEN システムは他のデータを保持しながら指定されたフィールドを更新しなければならない
3. WHEN ユーザーがプロフィールを取得する THEN システムは配列としてgoalsを含むすべてのユーザー情報を返さなければならない
4. WHEN ユーザーが複数の目標を設定する THEN システムはそれらを文字列の配列として保存しなければならない

### Requirement 3: 健康目標管理

**ユーザーストーリー:** ユーザーとして、健康目標を定義・管理したい。そうすることで、長期的な健康の理想状態を設定し、進捗を追跡できるようになる。

#### 受入基準

1. WHEN ユーザーが健康目標を追加する THEN システムはuserId、goalType、title、description、オプションのtargetValue、targetDateを含む目標を作成しなければならない
2. WHEN ユーザーが目標を更新する THEN システムはgoalIdを保持しながら指定された目標フィールドを変更しなければならない
3. WHEN ユーザーが目標を削除する THEN システムはデータベースから目標を削除しなければならない
4. WHEN ユーザーが目標を取得する THEN システムはそのユーザーのすべての目標を返さなければならない
5. WHEN 目標が作成される THEN システムはUUIDを使用して一意のgoalIdを生成しなければならない

### Requirement 4: 健康ポリシー管理

**ユーザーストーリー:** ユーザーとして、健康ポリシーを定義・管理したい。そうすることで、具体的な健康活動のルールを確立できるようになる。

#### 受入基準

1. WHEN ユーザーが健康ポリシーを追加する THEN システムはuserId、policyType、title、description、rulesを含むポリシーを作成しなければならない
2. WHEN ユーザーがポリシーを更新する THEN システムはpolicyIdを保持しながら指定されたポリシーフィールドを変更しなければならない
3. WHEN ユーザーがポリシーを削除する THEN システムはデータベースからポリシーを削除しなければならない
4. WHEN ユーザーがポリシーを取得する THEN システムはそのユーザーのすべてのポリシーを返さなければならない
5. WHEN ポリシーが作成される THEN システムはUUIDを使用して一意のpolicyIdを生成しなければならない

### Requirement 5: 活動記録管理 - 追加機能

**ユーザーストーリー:** ユーザーとして、日々の健康活動を記録したい。そうすることで、時間経過に伴う健康行動を追跡できるようになる。

#### 受入基準

1. WHEN ユーザーが1つ以上の活動を追加する THEN システムはその日付の既存の活動にそれらを追加しなければならない
2. WHEN ユーザーが新しい日付に活動を追加する THEN システムはそれらの活動を含む新しいレコードを作成しなければならない
3. WHEN 活動が追加される THEN システムは各活動がtime、activityType、descriptionを持つことを検証しなければならない
4. WHEN 活動のitemsが文字列である THEN システムはそれを配列形式に変換しなければならない

### Requirement 6: 活動記録管理 - 更新機能

**ユーザーストーリー:** ユーザーとして、活動記録を更新したい。そうすることで、間違いを修正したり、不足している情報を追加できるようになる。

#### 受入基準

1. WHEN ユーザーが時刻で単一の活動を更新する THEN システムは他の活動を保持しながらその特定の活動のみを変更しなければならない
2. WHEN ユーザーが1日のすべての活動を更新する THEN システムはその日付のすべての活動を新しいリストで置き換えなければならない
3. WHEN 単一の活動を更新する THEN システムはactivityType、description、itemsの部分的な更新を許可しなければならない
4. WHEN 指定された時刻に活動が存在しない THEN システムは単一活動更新のエラーを返さなければならない

### Requirement 7: 活動記録管理 - 削除機能

**ユーザーストーリー:** ユーザーとして、特定の活動記録を削除したい。そうすることで、誤ったエントリや不要なエントリを削除できるようになる。

#### 受入基準

1. WHEN ユーザーが時刻で活動を削除する THEN システムはその特定の活動のみを削除しなければならない
2. WHEN 日付の最後の活動が削除される THEN システムは日付レコード全体を削除しなければならない
3. WHEN 指定された時刻に活動が存在しない THEN システムはエラーを返さなければならない

### Requirement 8: 活動記録管理 - 取得機能

**ユーザーストーリー:** ユーザーとして、活動履歴を取得したい。そうすることで、健康行動と進捗を確認できるようになる。

#### 受入基準

1. WHEN ユーザーが特定の日付の活動を要求する THEN システムはその日付のすべての活動を返さなければならない
2. WHEN 日付に活動が存在しない THEN システムはカウントゼロの空の配列を返さなければならない
3. WHEN ユーザーが日付範囲の活動を要求する THEN システムは範囲内のすべての日付の日次活動を返さなければならない
4. WHEN 日付範囲が365日を超える THEN システムはエラーでリクエストを拒否しなければならない
5. WHEN 日付範囲パラメータが無効である THEN システムは検証エラーを返さなければならない

### Requirement 9: MCP Gateway

**ユーザーストーリー:** AIクライアントとして、MCP経由でシステムと対話したい。そうすることで、健康データを簡単に記録・取得できるようになる。

#### 受入基準

1. WHEN AIクライアントがGatewayにリクエストを送信する THEN システムはMCPプロトコル形式を受け入れなければならない
2. WHEN Gatewayがリクエストを受信する THEN システムは適切なLambda関数にルーティングしなければならない
3. WHEN Lambdaがリクエストを処理する THEN システムはMCP形式で結果を返さなければならない
4. WHEN Gatewayがリクエストを認証する THEN システムはCognito discovery URLを使用したCustom JWT Authorizerを使用しなければならない

### Requirement 10: MCP Tools

**ユーザーストーリー:** AIクライアントとして、利用可能なツールを発見し呼び出したい。そうすることで、健康データの操作を効率的に実行できるようになる。

#### 受入基準

1. WHEN AIクライアントがtools/listを呼び出す THEN システムは利用可能なすべてのMCPツールのリストを返さなければならない
2. WHEN AIクライアントがtools/callを呼び出す THEN システムは対応するLambda関数を実行しなければならない
3. WHEN MCPリクエストにuserIdが含まれる THEN システムはすべての操作でそれを使用しなければならない
4. WHEN Lambdaが結果を返す THEN システムはMCPレスポンススキーマに従ってフォーマットしなければならない

### Requirement 11: データ永続化

**ユーザーストーリー:** システムとして、すべての健康データを確実に永続化したい。そうすることで、ユーザー情報が失われることがなくなる。

#### 受入基準

1. WHEN データがDynamoDBに書き込まれる THEN システムはポイントインタイムリカバリを有効にしなければならない
2. WHEN 同時リクエストが発生する THEN システムは条件式を使用した楽観的ロックを使用しなければならない
3. WHEN DynamoDB操作が失敗する THEN システムは指数バックオフで最大3回再試行しなければならない
4. WHEN 活動が保存される THEN システムはuserIdをパーティションキーとして、dateをソートキーとして使用しなければならない

### Requirement 12: エラーハンドリング

**ユーザーストーリー:** ユーザーとして、何か問題が発生したときに明確なエラーメッセージが欲しい。そうすることで、問題を理解して修正できるようになる。

#### 受入基準

1. WHEN 必須パラメータが欠落している THEN システムは特定のフィールド名を含む検証エラーを返さなければならない
2. WHEN データベース操作が失敗する THEN システムはエラーをログに記録し、ユーザーに一般的なエラーメッセージを返さなければならない
3. WHEN 認証が失敗する THEN システムは機密情報を公開せずに認証エラーを返さなければならない
4. WHEN 日付形式が無効である THEN システムは期待される形式を含むフォーマットエラーを返さなければならない

### Requirement 13: ロギングとモニタリング

**ユーザーストーリー:** システム管理者として、包括的なロギングが欲しい。そうすることで、問題のトラブルシューティングとシステムヘルスの監視ができるようになる。

#### 受入基準

1. WHEN Lambda関数が実行される THEN システムはすべての受信イベントをログに記録しなければならない
2. WHEN 操作が完了する THEN システムは関連する識別子を含む成功メッセージをログに記録しなければならない
3. WHEN エラーが発生する THEN システムはスタックトレースを含むエラー詳細をログに記録しなければならない
4. WHEN ログが作成される THEN システムはCloudWatch Logsで7日間保持しなければならない

### Requirement 14: セキュリティとアクセス制御

**ユーザーストーリー:** システムとして、最小権限アクセスを強制したい。そうすることで、コンポーネントが意図された操作のみを実行できるようになる。

#### 受入基準

1. WHEN Lambda関数がDynamoDBにアクセスする THEN システムは特定のテーブルへの読み書き権限のみを付与しなければならない
2. WHEN GatewayがLambdaを呼び出す THEN システムは特定の関数ARNを持つIAMロールを使用しなければならない
3. WHEN Bedrock AgentがLambdaを呼び出す THEN システムはサービスプリンシパルを検証しなければならない
4. WHEN Gatewayロールが引き受けられる THEN システムはソースアカウントとソースARN条件を検証しなければならない

### Requirement 15: MCPツール選択ガイダンス

**ユーザーストーリー:** AIクライアントとして、明確なツールの説明が欲しい。そうすることで、各ユーザーリクエストに適切なツールを選択できるようになる。

#### 受入基準

1. WHEN ツールの説明が提供される THEN システムは具体的なユースケース例を含めなければならない
2. WHEN 複数の類似したツールが存在する THEN システムはそれらの目的を明確に区別しなければならない
3. WHEN ツールに副作用がある THEN システムはどのデータが影響を受けるかを明示的に述べなければならない
4. WHEN ツールに使用制約がある THEN システムは各ツールをいつ使用すべきかを文書化しなければならない
