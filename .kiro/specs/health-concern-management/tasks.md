# 実装計画: HealthConcernManagement

## 概要

HealthConcernManagement機能をHealthmate-HealthManagerサービスに追加するための実装計画です。既存のHealthGoalManagementパターンに従い、DynamoDBテーブル、Lambda関数、AgentCore Gateway Target、MCPスキーマを段階的に実装します。

## タスク

- [x] 1. MCPスキーマファイルの作成
  - health-concern-management-mcp-schema.jsonファイルを作成
  - AddConcern、UpdateConcern、DeleteConcern、GetConcernsの4つのツールスキーマを定義
  - 既存のhealth-goal-management-mcp-schema.jsonを参考にする
  - _要件: 7.1, 7.2_

- [ ]* 1.1 MCPスキーマのプロパティテスト作成
  - **プロパティ11: MCPレスポンス形式の一貫性**
  - **検証対象: 要件7.3, 7.4, 7.5**

- [x] 2. DynamoDBテーブルの追加
  - CDKスタックにhealthmate-concernsテーブルを追加
  - パーティションキー: userId、ソートキー: concernId
  - status-indexグローバルセカンダリインデックスを追加
  - 既存のgoals_tableパターンに従う
  - _要件: 5.1, 5.2, 5.3_

- [ ]* 2.1 データベーススキーマのプロパティテスト作成
  - **プロパティ10: データベーススキーマの一貫性**
  - **検証対象: 要件5.1, 5.2, 5.3**

- [x] 3. Lambda関数の実装
  - lambda/health_concern/handler.pyファイルを作成
  - add_concern、update_concern、delete_concern、get_concerns関数を実装
  - 既存のhealth_goal/handler.pyパターンに従う
  - JWT認証、バリデーション、エラーハンドリングを含む
  - _要件: 1.1-1.6, 2.1-2.5, 3.1-3.3, 4.1-4.4, 6.1-6.4_

- [ ]* 3.1 悩み作成のプロパティテスト作成
  - **プロパティ1: 悩み作成の包括性**
  - **検証対象: 要件1.1, 1.3, 1.4, 1.5, 1.6**

- [ ]* 3.2 カテゴリ検証のプロパティテスト作成
  - **プロパティ2: カテゴリ検証**
  - **検証対象: 要件1.2**

- [ ]* 3.3 悩み更新のプロパティテスト作成
  - **プロパティ3: 悩み更新の包括性**
  - **検証対象: 要件2.1, 2.3, 2.4**

- [ ]* 3.4 エラーハンドリングのプロパティテスト作成
  - **プロパティ4: 存在しないリソースのエラーハンドリング**
  - **検証対象: 要件2.2, 3.2**

- [ ]* 3.5 ステータス変更のプロパティテスト作成
  - **プロパティ5: ステータス変更の処理**
  - **検証対象: 要件2.5**

- [ ]* 3.6 悩み削除のプロパティテスト作成
  - **プロパティ6: 悩み削除の実行**
  - **検証対象: 要件3.1**

- [ ]* 3.7 アクセス制御のプロパティテスト作成
  - **プロパティ7: アクセス制御の統合**
  - **検証対象: 要件3.3, 4.4, 6.4**

- [ ]* 3.8 悩み取得のプロパティテスト作成
  - **プロパティ8: 悩み取得とソート**
  - **検証対象: 要件4.1, 4.2**

- [ ]* 3.9 認証要件のプロパティテスト作成
  - **プロパティ9: 認証要件**
  - **検証対象: 要件6.1, 6.2, 6.3**

- [x] 4. CDKスタックへのLambda関数追加
  - HealthConcernLambda関数をCDKスタックに追加
  - 環境変数、IAM権限、CloudWatch Logsの設定
  - 既存のhealth_goal_lambdaパターンに従う
  - _要件: 5.1, 6.1-6.4_

- [x] 5. チェックポイント - 基本機能テスト
  - すべてのテストが通ることを確認
  - 質問があれば、ユーザーに確認する

- [x] 6. AgentCore Gateway Targetの追加
  - HealthConcernManagementTargetをCDKスタックに追加
  - MCPスキーマとLambda関数を連携
  - 既存のhealth_goal_targetパターンに従う
  - _要件: 7.1, 7.3-7.5_

- [x] 7. Lambda権限の設定
  - AgentCore GatewayからのLambda呼び出し権限を追加
  - 既存のhealth_goal_lambdaの権限設定パターンに従う
  - _要件: 6.1-6.4_

- [ ]* 7.1 統合テストの作成
  - AgentCore Gateway経由でのE2Eテスト
  - 実際のMCPプロトコルでの動作確認
  - _要件: 7.1, 7.3-7.5_

- [x] 8. 最終チェックポイント - 統合テスト
  - すべてのテストが通ることを確認
  - MCPプロトコル経由での動作確認
  - 質問があれば、ユーザーに確認する

## 注意事項

- `*`マークのタスクはオプションで、より高速なMVPのためにスキップ可能
- 各タスクは特定の要件への参照を含み、トレーサビリティを確保
- チェックポイントで段階的な検証を実施
- プロパティテストは普遍的な正確性プロパティを検証
- ユニットテストは特定の例とエッジケースを検証
- 既存のHealthGoalManagementパターンに従い、一貫性を保つ