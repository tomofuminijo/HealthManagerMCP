# 実装計画: Journal Management

## 概要

Journal Management機能を既存のHealthManagerサービスに新規追加として実装します。既存のコードベースに影響を与えることなく、新しいLambda関数、DynamoDBテーブル、MCPスキーマを追加します。

## タスク

- [x] 1. MCPスキーマファイルの作成
  - journal-management-mcp-schema.jsonファイルを作成
  - 5つのMCPツール（GetJournal、GetJournalsInRange、AddJournal、UpdateJournal、DeleteJournal）を定義
  - 既存のMCPスキーマ形式に準拠
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]* 1.1 MCPスキーマのプロパティテスト作成
  - **プロパティ 15: MCPツール認証**
  - **検証: 要件 6.6, 6.7**

- [x] 2. DynamoDBテーブル定義の追加
  - CDKスタックにhealthmate-journalsテーブルを追加
  - パーティションキー: userId、ソートキー: date
  - 既存のテーブル命名規則に準拠
  - _要件: 2.1, 2.2, 2.3, 8.3_

- [ ]* 2.1 DynamoDBテーブル構造のプロパティテスト作成
  - **プロパティ 4: DynamoDBキー構造の一貫性**
  - **検証: 要件 2.1, 2.2, 2.3**

- [x] 3. Lambda関数の実装
  - [x] 3.1 lambda/journal/handler.pyファイルの作成
    - 既存のLambda関数パターンに準拠
    - ログ設定、DynamoDB設定、エラーハンドリングを既存実装に合わせる
    - _要件: 8.1, 8.2, 8.4_

  - [ ]* 3.2 Lambda関数基本機能のプロパティテスト作成
    - **プロパティ 1: 日記エントリーの作成と取得**
    - **検証: 要件 1.1, 3.1**

  - [x] 3.3 GetJournal機能の実装
    - 特定日の日記エントリー取得
    - 存在しない場合の適切なエラーレスポンス
    - _要件: 3.1, 3.3_

  - [ ]* 3.4 GetJournal機能のプロパティテスト作成
    - **プロパティ 10: 存在しないエントリーのエラー処理**
    - **検証: 要件 3.3, 4.5, 5.3**

  - [x] 3.5 GetJournalsInRange機能の実装
    - 日付範囲での日記エントリー取得
    - 365日制限の実装
    - 時系列ソート機能
    - _要件: 3.2, 3.4, 3.5_

  - [ ]* 3.6 GetJournalsInRange機能のプロパティテスト作成
    - **プロパティ 7: 日付範囲クエリの完全性**
    - **プロパティ 14: 日付範囲制限**
    - **検証: 要件 3.2, 3.4, 3.5**

  - [x] 3.7 AddJournal機能の実装
    - 新規日記エントリー作成
    - 既存エントリーへの追記機能
    - タグ保存機能（AIクライアント提供）
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [ ]* 3.8 AddJournal機能のプロパティテスト作成
    - **プロパティ 2: 日記追記の累積性**
    - **プロパティ 3: タグ保存の一貫性**
    - **検証: 要件 1.3, 1.4, 2.6, 6.8**

  - [x] 3.9 UpdateJournal機能の実装
    - 既存日記エントリーの完全置換
    - タイムスタンプ管理（createdAt保持、updatedAt更新）
    - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ]* 3.10 UpdateJournal機能のプロパティテスト作成
    - **プロパティ 6: タイムスタンプ管理**
    - **プロパティ 8: 日記更新の完全性**
    - **検証: 要件 2.7, 2.8, 4.1, 4.2, 4.3, 4.4**

  - [x] 3.11 DeleteJournal機能の実装
    - 日記エントリーの削除
    - ユーザー分離の確認
    - _要件: 5.1, 5.2, 5.4, 5.5_

  - [ ]* 3.12 DeleteJournal機能のプロパティテスト作成
    - **プロパティ 9: 日記削除の確実性**
    - **プロパティ 11: ユーザー分離とアクセス制御**
    - **検証: 要件 5.1, 5.2, 5.4, 5.5, 7.7**

- [x] 4. データ検証機能の実装
  - [x] 4.1 気分スコア検証の実装
    - 1-5の範囲チェック
    - 整数型チェック
    - _要件: 7.1, 7.2_

  - [ ]* 4.2 気分スコア検証のプロパティテスト作成
    - **プロパティ 5: 気分スコア検証**
    - **検証: 要件 1.2, 2.5, 7.1, 7.2**

  - [x] 4.3 日付検証の実装
    - YYYY-MM-DD形式チェック
    - 未来日付の拒否
    - _要件: 7.3, 7.4_

  - [ ]* 4.4 日付検証のプロパティテスト作成
    - **プロパティ 12: 日付検証**
    - **検証: 要件 7.3, 7.4**

  - [x] 4.5 コンテンツ検証の実装
    - 長さ制限チェック
    - セキュリティサニタイゼーション
    - _要件: 7.5, 7.6_

  - [ ]* 4.6 コンテンツ検証のプロパティテスト作成
    - **プロパティ 13: コンテンツ制限とサニタイゼーション**
    - **検証: 要件 7.5, 7.6**

- [x] 5. CDKインフラストラクチャの更新
  - [x] 5.1 Lambda関数リソースの追加
    - JournalLambda関数の定義
    - 環境変数設定（JOURNALS_TABLE_NAME）
    - IAMロール設定
    - _要件: 8.5, 8.7_

  - [x] 5.2 DynamoDBテーブルリソースの追加
    - healthmate-journalsテーブルの作成
    - Lambda関数へのアクセス権限付与
    - _要件: 8.3, 8.5_

  - [x] 5.3 AgentCore Gateway統合
    - 新しいMCPツールのGatewayへの登録
    - 既存のGateway設定パターンに準拠
    - _要件: 8.6, 8.7_

- [ ] 6. チェックポイント - 基本機能テスト
  - すべてのテストが通ることを確認し、ユーザーに質問があれば尋ねる

- [ ]* 7. 統合テストの実装
  - [ ]* 7.1 E2Eテストスイートの作成
    - 実際のDynamoDBを使用した統合テスト
    - 複数ツール間の連携テスト
    - _要件: 8.1, 8.2_

  - [ ]* 7.2 パフォーマンステストの作成
    - 大量データでの範囲クエリテスト
    - レスポンス時間測定
    - _要件: 3.4, 9.4_

- [ ] 8. 最終チェックポイント - 全機能テスト
  - すべてのテストが通ることを確認し、ユーザーに質問があれば尋ねる

## 注記

- `*`マークのタスクはオプションで、より迅速なMVPのためにスキップ可能
- 各タスクは特定の要件を参照し、トレーサビリティを確保
- チェックポイントで段階的な検証を実施
- プロパティテストは包括的な正確性検証を提供
- 単体テストは特定の例とエッジケースを検証