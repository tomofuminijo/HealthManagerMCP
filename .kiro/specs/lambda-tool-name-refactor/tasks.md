# 実装計画

- [ ] 1. 共通ツール名処理ユーティリティの作成
  - Lambda関数間で共有するツール名抽出・正規化ユーティリティ関数を作成
  - context.client_context.customからのツール名取得ロジックを実装
  - '__'分割と先頭'_'除去の正規化処理を実装
  - _要件: 1.1, 1.2, 1.3_

- [ ]* 1.1 ツール名正規化のプロパティテストを作成
  - **プロパティ1: ツール名正規化の一貫性**
  - **検証対象: 要件1.2、1.3**

- [ ] 2. UserLambda関数のリファクタリング
  - 既存のパラメータベースのツール名推測処理を削除
  - 新しいツール名取得処理に置き換え
  - ツール名と関数のマッピング辞書を実装
  - エラーハンドリングとログ出力を更新
  - _要件: 2.1, 2.2, 2.3, 2.4_

- [ ]* 2.1 UserLambda関数ディスパッチのプロパティテストを作成
  - **プロパティ2: 関数ディスパッチの正確性（User関数）**
  - **検証対象: 要件2.2-2.4**

- [ ]* 2.2 UserLambdaレスポンス形式のプロパティテストを作成
  - **プロパティ3: レスポンス形式の一貫性（User関数）**
  - **検証対象: 要件6.2**

- [ ] 3. HealthGoalLambda関数のリファクタリング
  - 既存のパラメータベースのツール名推測処理を削除
  - 新しいツール名取得処理に置き換え
  - ツール名と関数のマッピング辞書を実装
  - エラーハンドリングとログ出力を更新
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ]* 3.1 HealthGoalLambda関数ディスパッチのプロパティテストを作成
  - **プロパティ2: 関数ディスパッチの正確性（Goal関数）**
  - **検証対象: 要件3.2-3.5**

- [ ] 4. HealthPolicyLambda関数のリファクタリング
  - 既存のパラメータベースのツール名推測処理を削除
  - 新しいツール名取得処理に置き換え
  - ツール名と関数のマッピング辞書を実装
  - エラーハンドリングとログ出力を更新
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ]* 4.1 HealthPolicyLambda関数ディスパッチのプロパティテストを作成
  - **プロパティ2: 関数ディスパッチの正確性（Policy関数）**
  - **検証対象: 要件4.2-4.5**

- [ ] 5. ActivityLambda関数のリファクタリング
  - 既存のパラメータベースのツール名推測処理を削除
  - 新しいツール名取得処理に置き換え
  - ツール名と関数のマッピング辞書を実装
  - エラーハンドリングとログ出力を更新
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7_

- [ ]* 5.1 ActivityLambda関数ディスパッチのプロパティテストを作成
  - **プロパティ2: 関数ディスパッチの正確性（Activity関数）**
  - **検証対象: 要件5.2-5.7**

- [ ] 6. チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があれば質問する

- [ ]* 6.1 ログメッセージ正確性のプロパティテストを作成
  - **プロパティ4: ログメッセージの正確性**
  - **検証対象: 要件6.4**

- [ ]* 6.2 統合テストの作成
  - 各Lambda関数の完全なリクエスト/レスポンスサイクルをテスト
  - 既存機能の回帰テストを実装
  - MCPプロトコル互換性テストを実装
  - _要件: 6.1, 6.2, 6.3_

- [ ] 7. 最終チェックポイント - すべてのテストが通ることを確認
  - すべてのテストが通ることを確認し、問題があれば質問する