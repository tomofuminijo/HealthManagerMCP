# 実装計画: 身体測定値記録機能

## 概要

HealthManagerサービスに身体測定値記録機能を追加します。DynamoDBテーブル、Lambda関数、MCPツールを実装し、Latest/Oldestレコード管理ロジックを含む完全な測定データ管理システムを構築します。

## タスク

- [x] 1. DynamoDBテーブルとCDKインフラストラクチャのセットアップ
  - healthmate-body-measurementsテーブルの作成
  - Local Secondary Index (RecordTypeIndex) の設定
  - Lambda関数リソースの定義
  - IAM権限の設定
  - _要件: 2.1, 2.2, 2.3, 7.3, 7.5_

- [ ]* 1.1 CDKインフラストラクチャのプロパティテスト
  - **プロパティ 7: DynamoDB キー構造の一貫性**
  - **検証: 要件 2.2, 2.3**

- [x] 2. 身体測定値バリデーション機能の実装
  - 測定値範囲検証ロジックの実装
  - タイムスタンプ検証機能の実装
  - エラーメッセージ生成機能の実装
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]* 2.1 測定値バリデーションのプロパティテスト
  - **プロパティ 11: 無効測定値の拒否**
  - **検証: 要件 6.1**

- [ ]* 2.2 タイムスタンプバリデーションのプロパティテスト
  - **プロパティ 12: 未来タイムスタンプの拒否**
  - **検証: 要件 6.5**

- [x] 3. 基本的な測定記録機能の実装
  - addBodyMeasurement ツールの実装
  - 通常測定レコードの保存機能
  - JWT認証とユーザーID抽出機能
  - _要件: 1.1, 1.2, 1.3, 5.1, 5.7_

- [ ]* 3.1 測定値記録の往復一貫性プロパティテスト
  - **プロパティ 1: 測定値記録の往復一貫性**
  - **検証: 要件 2.4, 2.5, 2.6**

- [ ]* 3.2 タイムスタンプ指定の正確性プロパティテスト
  - **プロパティ 2: タイムスタンプ指定の正確性**
  - **検証: 要件 1.2**

- [ ]* 3.3 複数測定値同期記録のプロパティテスト
  - **プロパティ 3: 複数測定値の同期記録**
  - **検証: 要件 1.3**

- [ ]* 3.4 JWT認証必須性のプロパティテスト
  - **プロパティ 10: JWT認証の必須性**
  - **検証: 要件 5.7**

- [x] 4. Latest/Oldestレコード管理機能の実装
  - 初回記録時のLatest/Oldest同期処理
  - Latest レコード更新ロジック
  - Oldest レコード管理ロジック
  - 部分測定タイプの処理
  - _要件: 1.4, 1.5, 3.1, 3.2, 3.5_

- [ ]* 4.1 Latest レコード部分更新不変性のプロパティテスト
  - **プロパティ 4: Latest レコードの部分更新不変性**
  - **検証: 要件 1.5, 3.3**

- [ ]* 4.2 Latest レコード最新性保証のプロパティテスト
  - **プロパティ 5: Latest レコードの最新性保証**
  - **検証: 要件 3.1**

- [ ]* 4.3 Oldest レコード最古性保証のプロパティテスト
  - **プロパティ 6: Oldest レコードの最古性保証**
  - **検証: 要件 3.2**

- [ ]* 4.4 Record Type属性制限のプロパティテスト
  - **プロパティ 8: Record Type 属性の制限**
  - **検証: 要件 3.5**

- [ ]* 4.5 初回記録時Latest/Oldest同期のプロパティテスト
  - **プロパティ 19: 初回記録時のLatest/Oldest同期**
  - **検証: 要件 3.1, 3.2**

- [ ]* 4.6 部分測定タイプ初回記録整合性のプロパティテスト
  - **プロパティ 20: 部分測定タイプの初回記録整合性**
  - **検証: 要件 1.5, 3.1, 3.2**

- [x] 5. チェックポイント - 基本機能の動作確認
  - 全てのテストが通ることを確認し、ユーザーに質問があれば確認する

- [x] 6. データ取得機能の実装
  - getLatestMeasurements ツールの実装
  - getOldestMeasurements ツールの実装
  - getMeasurementHistory ツールの実装
  - LSI を使用した効率的なクエリ実装
  - _要件: 5.2, 5.3, 5.4_

- [ ]* 6.1 測定値一意性のプロパティテスト
  - **プロパティ 9: 測定値一意性**
  - **検証: 要件 2.1**

- [x] 7. 更新・削除機能の実装
  - updateBodyMeasurement ツールの実装
  - deleteBodyMeasurement ツールの実装
  - 所有権検証機能の実装
  - _要件: 4.1, 4.3, 6.6_

- [ ]* 7.1 測定記録更新正確性のプロパティテスト
  - **プロパティ 13: 測定記録更新の正確性**
  - **検証: 要件 4.1**

- [ ]* 7.2 測定記録削除完全性のプロパティテスト
  - **プロパティ 15: 測定記録削除の完全性**
  - **検証: 要件 4.3**

- [ ]* 7.3 所有権検証のプロパティテスト
  - **プロパティ 18: 所有権検証**
  - **検証: 要件 6.6**

- [x] 8. Latest/Oldest再計算機能の実装
  - 更新時のLatest レコード再計算
  - 削除時のLatest レコード再計算
  - 削除時のOldest レコード再計算
  - トランザクション処理の実装
  - _要件: 4.2, 4.4, 4.5_

- [ ]* 8.1 Latest レコード再計算（更新時）のプロパティテスト
  - **プロパティ 14: Latest レコード再計算（更新時）**
  - **検証: 要件 4.2**

- [ ]* 8.2 Latest レコード再計算（削除時）のプロパティテスト
  - **プロパティ 16: Latest レコード再計算（削除時）**
  - **検証: 要件 4.4**

- [ ]* 8.3 Oldest レコード再計算（削除時）のプロパティテスト
  - **プロパティ 17: Oldest レコード再計算（削除時）**
  - **検証: 要件 4.5**

- [x] 9. MCPスキーマファイルの作成
  - body-measurement-mcp-schema.json の作成
  - 全MCPツールの定義
  - 入力スキーマとバリデーションルールの定義
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [ ]* 9.1 MCPツール存在確認のテスト
  - 全ての必要なMCPツールが定義されていることを確認
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [x] 10. エラーハンドリングとログ機能の実装
  - DynamoDBエラーハンドリング
  - 統一されたエラーレスポンス形式
  - ログ機能の実装
  - _要件: 7.1, 7.2, 7.4_

- [ ]* 10.1 エラーハンドリングの単体テスト
  - 各種エラー条件での適切なレスポンス確認
  - _要件: 7.1, 7.2_

- [x] 11. 統合テストとE2Eテスト
  - Lambda関数の統合テスト
  - MCP プロトコル経由のE2Eテスト
  - 実際のDynamoDBとの連携テスト
  - _要件: 全要件の統合確認_

- [x] 11.1 統合テストの実装
  - 実際のAWS環境での動作確認
  - 全機能の連携テスト

- [x] 12. 最終チェックポイント - 全機能の動作確認
  - 全てのテストが通ることを確認し、ユーザーに質問があれば確認する

## 注意事項

- `*` マークの付いたタスクはオプションで、より迅速なMVPのためにスキップ可能です
- 各タスクは特定の要件を参照し、トレーサビリティを確保しています
- チェックポイントで段階的な検証を行い、問題の早期発見を図ります
- プロパティテストは汎用的な正確性プロパティを検証します
- 単体テストは特定の例とエッジケースを検証します