# 要件ドキュメント

## 概要

Healthmate-HealthManagerサービスの既存ユーザー管理MCPツール（AddUser、UpdateUser、GetUser）に生年月日（dateOfBirth）フィールドを追加し、ユーザーの年齢に基づいたパーソナライズされた健康管理を可能にします。

## 用語集

- **ユーザー管理システム**: HealthManagerMCPのユーザー情報管理システム
- **生年月日**: ユーザーの生年月日（YYYY-MM-DD形式の文字列）
- **MCPスキーマ**: Model Context Protocol のツール定義スキーマ
- **Lambda関数**: AWS Lambda関数のハンドラー（lambda/user/handler.py）
- **DynamoDBテーブル**: ユーザー情報を格納するDynamoDBテーブル（healthmate-users）

## 要件

### 要件1: AddUserツールへの生年月日フィールド追加

**ユーザーストーリー:** ユーザーとして、新規登録時に生年月日を登録したい。年齢に応じた健康アドバイスを受けるため。

#### 受け入れ基準

1. WHEN ユーザーが新規作成時に生年月日を提供する THEN ユーザー管理システム SHALL YYYY-MM-DD形式で保存する
2. WHEN ユーザーが新規作成時に生年月日を提供しない THEN ユーザー管理システム SHALL このフィールドを必須とせずにユーザーを作成する
3. WHEN 生年月日が提供される THEN ユーザー管理システム SHALL 過去の有効な日付であることを検証する
4. WHEN 無効な日付形式が提供される THEN ユーザー管理システム SHALL 明確なメッセージとともに検証エラーを返す

### 要件2: UpdateUserツールへの生年月日フィールド追加

**ユーザーストーリー:** 既存ユーザーとして、プロフィール情報を完成させるために生年月日を追加または更新したい。

#### 受け入れ基準

1. WHEN 既存ユーザーが生年月日でプロフィールを更新する THEN ユーザー管理システム SHALL 新しい生年月日を保存する
2. WHEN 既存ユーザーが有効な日付で生年月日を更新する THEN ユーザー管理システム SHALL 以前の値を置き換える
3. WHEN 既存ユーザーが更新時に空またはnullの生年月日を提供する THEN ユーザー管理システム SHALL 生年月日フィールドを削除する
4. WHEN 生年月日を更新する THEN ユーザー管理システム SHALL 日付形式を検証し過去の日付であることを確認する

### 要件3: GetUserツールでの生年月日取得

**ユーザーストーリー:** システムとして、年齢に応じたサービスを提供するためにユーザーの生年月日情報を取得したい。

#### 受け入れ基準

1. WHEN ユーザー情報を取得する THEN ユーザー管理システム SHALL 生年月日が存在する場合はそれを含める
2. WHEN 生年月日のないユーザーの情報を取得する THEN ユーザー管理システム SHALL nullを返すかフィールドを省略する
3. WHEN 生年月日が存在する THEN ユーザー管理システム SHALL YYYY-MM-DD形式で返す
4. THE ユーザー管理システム SHALL 既存のAPIコンシューマーとの後方互換性を維持する

### 要件4: MCPスキーマの更新

**ユーザーストーリー:** AIエージェントとして、パーソナライズされた健康コーチングを提供するためにMCPツール経由で生年月日情報にアクセスしたい。

#### 受け入れ基準

1. WHEN MCPスキーマが更新される THEN MCPスキーマ SHALL AddUserツールにdateOfBirthをオプションフィールドとして含める
2. WHEN MCPスキーマが更新される THEN MCPスキーマ SHALL UpdateUserツールにdateOfBirthをオプションフィールドとして含める
3. WHEN MCPスキーマが更新される THEN MCPスキーマ SHALL GetUserツールのレスポンススキーマにdateOfBirthを含める
4. THE MCPスキーマ SHALL dateOfBirth形式をYYYY-MM-DDパターンの文字列として指定する

### 要件5: データ検証とエラーハンドリング

**ユーザーストーリー:** システム管理者として、データ整合性を維持するために生年月日データの適切な検証を行いたい。

#### 受け入れ基準

1. WHEN 生年月日が提供される THEN ユーザー管理システム SHALL YYYY-MM-DD形式に一致することを検証する
2. WHEN 生年月日が未来の日付を表す THEN ユーザー管理システム SHALL 適切なエラーメッセージとともに拒否する
3. WHEN 生年月日が非現実的な過去の日付を表す（例：1900年以前） THEN ユーザー管理システム SHALL 適切なエラーメッセージとともに拒否する
4. WHEN 日付検証が失敗する THEN ユーザー管理システム SHALL 各検証失敗タイプに対して具体的なエラーメッセージを返す

### 要件6: 既存データとの互換性

**ユーザーストーリー:** システム保守担当者として、現在のユーザーが更新の影響を受けないように既存のユーザーデータが機能し続けることを確認したい。

#### 受け入れ基準

1. WHEN システムが更新される THEN ユーザー管理システム SHALL 生年月日のない既存ユーザーでも引き続き動作する
2. WHEN 生年月日のない既存ユーザーを取得する THEN ユーザー管理システム SHALL 失敗やエラーを返さない
3. WHEN 既存ユーザーを更新する THEN ユーザー管理システム SHALL 他のフィールドに影響を与えることなく生年月日の追加を許可する
4. THE ユーザー管理システム SHALL 生年月日のないユーザーに対して既存のすべての機能を維持する